<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>encapsulation</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/v3.18.x/encapsulation><meta property=og:type content=website><meta property=og:title content=encapsulation><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=encapsulation><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.7b9a86078f3cc4f5.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css crossorigin=anonymous><meta name=robots content="noindex, nofollow"></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span class="control has-icons-left navbar-item"><input id=algolia-search-input class=input type=search placeholder=""> <span class="icon is-medium is-left"><i class="fa fa-search"></i> </span></span><a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (v3.18.1)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile" data-sticky-container><aside class="menu sticky"><ul class=menu-list><li style="text-transform: capitalize"><a title=benchmarking href=/docs/v3.18.x/benchmarking>benchmarking</a></li><li style="text-transform: capitalize"><a title=contenttypeparser href=/docs/v3.18.x/contenttypeparser>contenttypeparser</a></li><li style="text-transform: capitalize"><a title=decorators href=/docs/v3.18.x/decorators>decorators</a></li><li style="text-transform: capitalize"><a title=ecosystem href=/docs/v3.18.x/ecosystem>ecosystem</a></li><li style="text-transform: capitalize" id=doc-menu-section><a title=encapsulation class=is-active href=/docs/v3.18.x/encapsulation>encapsulation</a></li><li style="text-transform: capitalize"><a title=errors href=/docs/v3.18.x/errors>errors</a></li><li style="text-transform: capitalize"><a title=fluent-schema href=/docs/v3.18.x/fluent-schema>fluent-schema</a></li><li style="text-transform: capitalize"><a title=getting-started href=/docs/v3.18.x/getting-started>getting-started</a></li><li style="text-transform: capitalize"><a title=http2 href=/docs/v3.18.x/http2>http2</a></li><li style="text-transform: capitalize"><a title=hooks href=/docs/v3.18.x/hooks>hooks</a></li><li style="text-transform: capitalize"><a title=lts href=/docs/v3.18.x/lts>lts</a></li><li style="text-transform: capitalize"><a title=lifecycle href=/docs/v3.18.x/lifecycle>lifecycle</a></li><li style="text-transform: capitalize"><a title=logging href=/docs/v3.18.x/logging>logging</a></li><li style="text-transform: capitalize"><a title=middleware href=/docs/v3.18.x/middleware>middleware</a></li><li style="text-transform: capitalize"><a title=migration-guide-v3 href=/docs/v3.18.x/migration-guide-v3>migration-guide-v3</a></li><li style="text-transform: capitalize"><a title=plugins-guide href=/docs/v3.18.x/plugins-guide>plugins-guide</a></li><li style="text-transform: capitalize"><a title=plugins href=/docs/v3.18.x/plugins>plugins</a></li><li style="text-transform: capitalize"><a title=recommendations href=/docs/v3.18.x/recommendations>recommendations</a></li><li style="text-transform: capitalize"><a title=reply href=/docs/v3.18.x/reply>reply</a></li><li style="text-transform: capitalize"><a title=request href=/docs/v3.18.x/request>request</a></li><li style="text-transform: capitalize"><a title=routes href=/docs/v3.18.x/routes>routes</a></li><li style="text-transform: capitalize"><a title=server href=/docs/v3.18.x/server>server</a></li><li style="text-transform: capitalize"><a title=serverless href=/docs/v3.18.x/serverless>serverless</a></li><li style="text-transform: capitalize"><a title=style-guide href=/docs/v3.18.x/style-guide>style-guide</a></li><li style="text-transform: capitalize"><a title=testing href=/docs/v3.18.x/testing>testing</a></li><li style="text-transform: capitalize"><a title=typescript href=/docs/v3.18.x/typescript>typescript</a></li><li style="text-transform: capitalize"><a title=validation-and-serialization href=/docs/v3.18.x/validation-and-serialization>validation-and-serialization</a></li><li style="text-transform: capitalize"><a title=write-plugin href=/docs/v3.18.x/write-plugin>write-plugin</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option selected value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/ >Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option selected value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><li style="text-transform: capitalize" class=is-active><a>encapsulation</a></li></ul></nav><div id=doc-content class=content><p><a id=encapsulation></a></p><h2 id=encapsulation>Encapsulation</h2><p>A fundamental feature of Fastify is the &quot;encapsulation context.&quot; The encapsulation context governs which <a href=/docs/v3.18.x/Decorators>decorators</a>, registered <a href=/docs/v3.18.x/Hooks>hooks</a>, and <a href=/docs/v3.18.x/Plugins>plugins</a> are available to <a href=/docs/v3.18.x/Routes>routes</a>. A visual representation of the encapsulation context is shown in the following figure:</p><p><img src=/docs/v3.18.x/resources/encapsulation_context.9f299f2791e82cfc.svg alt=null title=null></p><p>In the above figure, there are several entities:</p><ol><li>The <em>root context</em></li><li>Three <em>root plugins</em></li><li>Two <em>child contexts</em> where each <em>child context</em> has<ul><li>Two <em>child plugins</em></li><li>One <em>grandchild context</em> where each <em>grandchild context</em> has<ul><li>Three <em>child plugins</em></li></ul></li></ul></li></ol><p>Every <em>child context</em> and <em>grandchild context</em> has access to the <em>root plugins</em>. Within each <em>child context</em>, the <em>grandchild contexts</em> have access to the <em>child plugins</em> registered within the containing <em>child context</em>, but the containing <em>child context</em> <strong>does not</strong> have access to the <em>child plugins</em> registered within its <em>grandchild context</em>.</p><p>Given that everything in Fastify is a <a href=/docs/v3.18.x/Plugins>plugin</a>, except for the <em>root context</em>, every &quot;context&quot; and &quot;plugin&quot; in this example is a plugin that can consist of decorators, hooks, plugins, and routes. Thus, to put this example into concrete terms, consider a basic scenario of a REST API server that has three routes: the first route (<code>/one</code>) requires authentication, the second route (<code>/two</code>) does not, and the third route (<code>/three</code>) has access to the same context as the second route. Using <a href=https://github.com/fastify/fastify-bearer-auth>fastify-bearer-auth</a> to provide the authentication, the code for this example is as follows:</p><pre><code class=language-js>&#39;use strict&#39;

const fastify = require(&#39;fastify&#39;)()

fastify.decorateRequest(&#39;answer&#39;, 42)

fastify.register(async function authenticatedContext (childServer) {
  childServer.register(require(&#39;fastify-bearer-auth&#39;), { keys: [&#39;abc123&#39;] })

  childServer.route({
    path: &#39;/one&#39;,
    method: &#39;GET&#39;,
    handler (request, response) {
      response.send({
        answer: request.answer,
        // request.foo will be undefined as it&#39;s only defined in publicContext
        foo: request.foo,
        // request.bar will be undefined as it&#39;s only defined in grandchildContext
        bar: request.bar
      })
    }
  })
})

fastify.register(async function publicContext (childServer) {
  childServer.decorateRequest(&#39;foo&#39;, &#39;foo&#39;)

  childServer.route({
    path: &#39;/two&#39;,
    method: &#39;GET&#39;,
    handler (request, response) {
      response.send({
        answer: request.answer,
        foo: request.foo,
        // request.bar will be undefined as it&#39;s only defined in grandchildContext
        bar: request.bar
      })
    }
  })

  childServer.register(async function grandchildContext (grandchildServer) {
    grandchildServer.decorateRequest(&#39;bar&#39;, &#39;bar&#39;)

    grandchildServer.route({
      path: &#39;/three&#39;,
      method: &#39;GET&#39;,
      handler (request, response) {
        response.send({
          answer: request.answer,
          foo: request.foo,
          bar: request.bar
        })
      }
    })
  })
})

fastify.listen(8000)
</code></pre><p>The above server example shows all of the encapsulation concepts outlined in the original diagram:</p><ol><li>Each <em>child context</em> (<code>authenticatedContext</code>, <code>publicContext</code>, and <code>grandchildContext</code>) has access to the <code>answer</code> request decorator defined in the <em>root context</em>.</li><li>Only the <code>authenticatedContext</code> has access to the <code>fastify-bearer-auth</code> plugin.</li><li>Both the <code>publicContext</code> and <code>grandchildContext</code> have access to the <code>foo</code> request decorator.</li><li>Only the <code>grandchildContext</code> has access to the <code>bar</code> request decorator.</li></ol><p>To see this, start the server and issue requests:</p><pre><code class=language-sh># curl -H &#39;authorization: Bearer abc123&#39; http://127.0.0.1:8000/one
{&quot;answer&quot;:42}
# curl http://127.0.0.1:8000/two
{&quot;answer&quot;:42,&quot;foo&quot;:&quot;foo&quot;}
# curl http://127.0.0.1:8000/three
{&quot;answer&quot;:42,&quot;foo&quot;:&quot;foo&quot;,&quot;bar&quot;:&quot;bar&quot;}
</code></pre><p><a id=shared-context></a></p><h2 id=sharing-between-contexts>Sharing Between Contexts</h2><p>Notice that each context in the prior example inherits <em>only</em> from the parent contexts. Parent contexts cannot access any entities within their descendent contexts. This default is occasionally not desired. In such cases, the encapsulation context can be broken through the usage of <a href=https://github.com/fastify/fastify-plugin>fastify-plugin</a> such that anything registered in a descendent context is available to the containing parent context.</p><p>Assuming the <code>publicContext</code> needs access to the <code>bar</code> decorator defined within the <code>grandchildContext</code> in the previous example, the code can be rewritten to:</p><pre><code class=language-js>&#39;use strict&#39;

const fastify = require(&#39;fastify&#39;)()
const fastifyPlugin = require(&#39;fastify-plugin&#39;)

fastify.decorateRequest(&#39;answer&#39;, 42)

// `authenticatedContext` omitted for clarity

fastify.register(async function publicContext (childServer) {
  childServer.decorateRequest(&#39;foo&#39;, &#39;foo&#39;)

  childServer.route({
    path: &#39;/two&#39;,
    method: &#39;GET&#39;,
    handler (request, response) {
      response.send({
        answer: request.answer,
        foo: request.foo,
        bar: request.bar
      })
    }
  })

  childServer.register(fastifyPlugin(grandchildContext))

  async function grandchildContext (grandchildServer) {
    grandchildServer.decorateRequest(&#39;bar&#39;, &#39;bar&#39;)

    grandchildServer.route({
      path: &#39;/three&#39;,
      method: &#39;GET&#39;,
      handler (request, response) {
        response.send({
          answer: request.answer,
          foo: request.foo,
          bar: request.bar
        })
      }
    })
  }
})

fastify.listen(8000)
</code></pre><p>Restarting the server and re-issuing the requests for <code>/two</code> and <code>/three</code>:</p><pre><code class=language-sh># curl http://127.0.0.1:8000/two
{&quot;answer&quot;:42,&quot;foo&quot;:&quot;foo&quot;,&quot;bar&quot;:&quot;bar&quot;}
# curl http://127.0.0.1:8000/three
{&quot;answer&quot;:42,&quot;foo&quot;:&quot;foo&quot;,&quot;bar&quot;:&quot;bar&quot;}
</code></pre></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2021 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.97eeabf1df4ff87e.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({
        apiKey: 'f7c62ddab40e653f67a6e15be761d951',
        indexName: 'fastify',
        inputSelector: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] },
        debug: false // Set debug to true if you want to inspect the dropdown
      });</script></body></html>